# 修复步骤：提案详情页面

## 当前状态

### ✅ 已完成
1. **GraphQL Schema 更新** - 修复了字段命名问题（camelCase vs snake_case）
2. **TypeScript 类型** - 更新了 ProposalVersion 接口
3. **GraphQL 查询** - 添加了缺失的字段
4. **Resolver 逻辑** - 添加了全面的回退逻辑
5. **组件更新** - 更新了所有字段引用
6. **骨架屏组件** - 创建并集成了加载状态组件

### ⚠️ 待处理 - 重要
**RLS 策略阻止数据访问**

服务器日志显示：
```
version_count: 0
workspace_count: 0
```

这表明行级安全策略（RLS）阻止了对以下表的访问：
- `proposal_versions`
- `workspaces`
- `workspace_documents`
- `document_sections`

## 必需操作：执行 RLS 修复脚本

### 步骤 1：打开 Supabase SQL 编辑器
1. 进入你的 Supabase 项目控制台
2. 点击左侧边栏的 **SQL Editor**
3. 点击 **New Query**

### 步骤 2：执行修复脚本
将 `FIX-PROPOSAL-DETAIL-RLS.sql` 文件的内容复制粘贴到 SQL 编辑器中并运行。

这个脚本将：
1. **修复 proposal_versions RLS** - 允许提案负责人、团队成员和项目客户读取版本
2. **修复 workspaces RLS** - 允许提案团队成员访问他们项目的工作区
3. **修复 workspace_documents RLS** - 允许提案团队成员读取文档
4. **修复 document_sections RLS** - 允许提案团队成员读取章节

### 步骤 3：验证修复
运行脚本后，验证查询将显示：
- 所有新策略已创建
- 每个表的策略数量

预期输出：
```
proposal_versions_policies: 2
workspaces_policies: 4
workspace_documents_policies: 4
document_sections_policies: 4
```

### 步骤 4：测试页面
1. 访问：`http://localhost:3000/client-projects/ef03c80f-313c-455e-9c57-27256a751335/decision?proposal=6515207e-dbb8-466d-8426-caebbefbb2e5`
2. 检查浏览器控制台和服务器日志
3. 验证：
   - `version_count` > 0
   - `workspace_count` > 0
   - 章节和文档正常显示
   - 版本历史可见

## 修复说明

### 当前问题
Resolver 有完整的回退逻辑：
1. 尝试从 `workspaces` → `workspace_documents` → `document_sections` 获取
2. 如果失败，尝试 `proposal_versions.sections_snapshot`
3. 如果还是失败，尝试 `proposal_versions.content.sections`

但是，**所有这些查询都被 RLS 策略阻止了**，所以没有数据返回。

### 解决方案
RLS 修复脚本创建的策略允许：
- **提案负责人**：对其提案的版本和工作区数据的完全访问权限
- **团队成员**：对分配给他们的提案版本和工作区数据的读取权限
- **项目客户**：对其项目的提案版本的读取权限

## 修复后

RLS 策略修复后，页面应该显示：
- ✅ 提案文档章节
- ✅ 带创建者名称的版本历史
- ✅ 文档列表
- ✅ 所有提案详情
- ✅ 骨架屏加载状态

## 故障排除

如果运行脚本后数据仍然不显示：

1. **检查 RLS 是否启用**：
   ```sql
   SELECT tablename, rowsecurity 
   FROM pg_tables 
   WHERE tablename IN ('proposal_versions', 'workspaces', 'workspace_documents', 'document_sections');
   ```

2. **检查用户认证**：
   - 确保以正确的用户身份登录
   - 验证用户角色（客户、负责人或团队成员）

3. **检查数据是否存在**：
   ```sql
   -- 检查提案版本是否存在
   SELECT COUNT(*) FROM proposal_versions WHERE proposal_id = '6515207e-dbb8-466d-8426-caebbefbb2e5';
   
   -- 检查工作区是否存在
   SELECT COUNT(*) FROM workspaces WHERE project_id = 'ef03c80f-313c-455e-9c57-27256a751335';
   ```

## 总结

代码更改已完成且正确。唯一剩下的步骤是在 Supabase 中**执行 RLS 修复脚本**，以允许 resolver 访问所需的数据。

执行脚本后，提案详情视图将正常工作，包括所有功能：
- 文档章节显示
- 版本历史
- 文档列表
- 合规检查清单
- 团队信息
- 适当的骨架屏加载状态
